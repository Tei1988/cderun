# cderun 実装ガイド

## 概要

このドキュメントは`cderun`の実装を段階的に進めるためのガイドです。
各ステップは依存関係を考慮して順序付けられており、前のステップが完了してから次に進みます。

## 現在の実装状況

### 実装済み
- 基本的なCLI構造（Cobra使用）
- 厳密な引数解析（P1/P2分離、Hoisting処理）
- ポリグロットエントリーポイント（シンボリックリンク検出）
- 基本的なコンテナ実行（Docker API使用）
- コンテナのライフサイクル管理（作成・起動・待機・削除）
- 標準入出力のアタッチ（TTY/インタラクティブ対応）
- 設定ファイル読み込み（`.cderun.yaml`, `.tools.yaml`）
- イメージマッピング（サブコマンドからイメージ名の解決）
- 優先順位解決ロジック（CLI, Env, YAML, Defaults の6階層）
- ドライランモード（`--dry-run` による設定のプレビュー、YAML/JSON/Simple形式対応）
- 環境変数処理（直接指定およびホストからのパススルー）
- ソケット・バイナリマウント、ツールマウント（自動バイナリマウント含む）
- コンテナ内作業ディレクトリ指定（`--workdir`）
- シグナルハンドリング（SIGINT/SIGTERMの転送、二段階終了）
- TTYリサイズ同期（SIGWINCH対応）
- 詳細ログ機能（レベル別出力、ファイル出力、JSON形式対応）

### 未実装
- Podmanフルサポート（現在はスタブ実装）
- ログローテーション機能
- `cderun logs`, `cderun debug` 等のユーティリティコマンド

## 実装フェーズ

### Phase 1: コア機能（必須） (Completed)
基本的なコンテナ実行機能を実装

### Phase 2: 設定管理 (Completed)
設定ファイルとイメージマッピング

### Phase 3: 高度な機能 (Completed)
環境変数、マウント機能など

### Phase 4: 利便性向上 (In Progress)
ドライラン（完了）、インタラクティブ性の向上（完了）、ログ（基本完了）、Podmanサポート（未完了）

---

## Phase 4: 利便性向上 (In Progress)

### Step 4.1: ドライランモード (Completed)

**目的**: 実際のコンテナ実行を行わずに、実行される内容をプレビューする。

---

### Step 4.2: インタラクティブ性の向上 (Completed)

**目的**: ターミナル操作の透過性を高める。

**実装内容**:
- シグナル転送（SIGINT, SIGTERM）
- TTYリサイズ同期（SIGWINCH）
- ターミナルRawモードの適切な制御

---

### Step 4.3: ログ・デバッグ (Completed)

**目的**: トラブルシューティングのために詳細な実行ログを表示する。

**実装内容**:
- 複数のログレベル（ERROR, WARN, INFO, DEBUG, TRACE）
- ファイル出力および標準エラー出力（tee対応）
- JSON形式およびテキスト形式のサポート

---

### Step 4.4: Podmanサポート (Planned)

**目的**: Podmanランタイムへの対応。

---

## 実装チェックリスト

### Phase 1 (Completed)
- [x] Step 1.1: ContainerConfig定義
- [x] Step 1.2: Runtimeインターフェース
- [x] Step 1.3: Docker API実装
- [x] Step 1.4: 基本実行フロー

### Phase 2 (Completed)
- [x] Step 2.1: 設定ファイル読み込み
- [x] Step 2.2: イメージマッピング
- [x] Step 2.3: 優先順位解決

### Phase 3 (Completed)
- [x] Step 3.1: 環境変数パススルー
- [x] Step 3.2: ソケットマウント
- [x] Step 3.3: cderunバイナリマウント
- [x] Step 3.4: ツールマウント

### Phase 4 (In Progress)
- [x] Step 4.1: ドライランモード
- [x] Step 4.2: インタラクティブ性の向上（シグナル、リサイズ）
- [x] Step 4.3: ログ・デバッグ
- [ ] Step 4.4: Podmanサポート

## 各ステップの完了基準

1. **コードが動作する**: 実装した機能が期待通りに動作
2. **テストが通る**: ユニットテストとインテグレーションテスト
3. **ドキュメントと一致**: featuresドキュメントの仕様通り
4. **エラーハンドリング**: 適切なエラーメッセージ

## 注意事項

- 各ステップは独立してテスト可能にする
- 前のステップが完了してから次に進む
- 既存のコードを壊さない
- featuresドキュメントを常に参照する
